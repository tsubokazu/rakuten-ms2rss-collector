# RSS API実装方針

## 概要
楽天証券MarketSpeed2のRSS API（RssChart、RssChartPast）を使用した期間指定データ取得システムの実装方針。

## 目標
- 期間指定（例：2025/01/01-2025/07/15）でのデータ取得
- 現在のUI（期間指定方式）を維持
- RSS API制約（3000本制限）を考慮した分割取得

## RSS API関数の特徴

### RssChart（最新データ取得）
- **構文**: `=RssChart(ヘッダー行,銘柄コード,足種,表示本数)`
- **対応足種**: T（ティック）、1M-60M（分足）、2H-8H（時間足）、D（日足）、W（週足）、M（月足）
- **特徴**: 最新のN本のデータを取得（開始日指定不可）
- **制限**: 最大3000本

### RssChartPast（過去データ取得）
- **構文**: `=RssChartPast(ヘッダー行,銘柄コード,足種,開始日,表示本数)`
- **対応足種**: D（日足）、W（週足）、M（月足）のみ
- **特徴**: 指定した開始日からN本のデータを取得
- **制限**: 最大3000本

## 実装アルゴリズム

### 1. 時間軸による関数選択

#### 分足データ（1M, 5M, 15M, 30M, 60M）
- **使用関数**: RssChart
- **戦略**: 
  1. 終了日から必要な営業日数を逆算
  2. 余裕を持って多めに取得（安全係数1.5）
  3. 取得後、期間外データをフィルタリング
  4. 3000本制限対応の分割取得

#### 日足以上（D, W, M）
- **使用関数**: RssChartPast
- **戦略**:
  1. 開始日と終了日から必要本数を正確に計算
  2. RssChartPastで開始日から取得
  3. 終了日以降のデータをフィルタリング
  4. 3000本制限対応の分割取得

### 2. 必要本数計算アルゴリズム

#### 分足データの場合
```
営業日数 = 開始日〜終了日の営業日数
1日あたりの本数 = 時間軸に応じた計算
- 1M: 約390本/日（6.5時間×60分）
- 5M: 約78本/日（6.5時間×60分/5分）
- 15M: 約26本/日（6.5時間×60分/15分）
- 30M: 約13本/日（6.5時間×60分/30分）
- 60M: 約6.5本/日（6.5時間）

必要本数 = 営業日数 × 1日あたりの本数 × 1.5（安全係数）
```

#### 日足以上の場合
```
- 日足: 営業日数
- 週足: 営業日数 / 5
- 月足: 営業日数 / 20（概算）
```

### 3. 分割取得アルゴリズム

#### 日足以上（RssChartPast使用）
```
必要本数 > 3000の場合:
1. 最初の3000本を取得（開始日から）
2. 取得した最終日の翌日を新しい開始日とする
3. 残り本数が3000本以下になるまで繰り返し
4. 最後の部分を取得
5. 全データを結合
```

#### 分足（RssChart使用）
```
必要本数 > 3000の場合:
1. 最新3000本を取得
2. 取得した最古日より前のデータが必要な場合：
   - 一時的に異なる戦略を使用
   - または日足データで補完
```

## 実装計画

### Phase 1: コア機能実装
1. **必要本数計算関数**
   - `CalculateRequiredDataPoints(startDate, endDate, timeFrame)`
   - 各時間軸に応じた本数計算ロジック

2. **RSS API呼び出し関数**
   - `CallRssChart(stockCode, timeFrame, dataPoints)`
   - `CallRssChartPast(stockCode, timeFrame, startDate, dataPoints)`

3. **分割取得関数**
   - `CollectDataInBatches(stockCode, timeFrame, startDate, endDate)`
   - 3000本制限を考慮した分割処理

### Phase 2: データ処理機能
1. **データフィルタリング**
   - 期間外データの除去
   - 重複データの処理

2. **データ結合**
   - 複数回の取得データを統合
   - 時系列順序の保証

### Phase 3: エラーハンドリング
1. **RSS API接続エラー**
2. **データ不整合エラー**
3. **期間指定エラー**

## ファイル構成

### 修正対象ファイル
- `DataCollector.bas`: メインデータ取得ロジック
- `Utils.bas`: 日付計算、営業日計算等のユーティリティ
- `CSVExporter.bas`: 出力形式は維持

### 維持するファイル
- `WorksheetMacros.bas`: UIは現在の期間指定方式を維持
- `MainModule.bas`: エントリポイントは変更なし

## テスト戦略

### テストケース
1. **短期間データ（1週間）**
   - 分足: 1M, 5M, 15M, 30M, 60M
   - 日足: D

2. **中期間データ（1ヶ月）**
   - 分割取得が不要な範囲

3. **長期間データ（1年以上）**
   - 分割取得が必要な範囲
   - 3000本制限のテスト

4. **エラーケース**
   - 不正な期間指定
   - 接続エラー
   - データ不足

## 実装上の注意点

### 1. 営業日計算
- 祝日、休市日を考慮した正確な営業日数計算
- 年末年始等の特別休日対応

### 2. 時間軸変換
- 分足データの取引時間（9:00-15:00）考慮
- 夏時間等の特殊ケース対応

### 3. パフォーマンス
- 大量データ取得時のメモリ使用量
- 分割取得時の処理時間最適化

### 4. 後方互換性
- 現在のテストモード（サンプルデータ生成）は維持
- 段階的な移行を可能にする

## 移行計画

### Phase 1: テストモード拡張
- 現在のサンプルデータ生成を期間指定に対応
- 新しいアルゴリズムの基本動作確認

### Phase 2: RSS API統合
- 実際のRssChart/RssChartPast呼び出し
- MarketSpeed2接続テスト

### Phase 3: 本番運用
- 十分なテスト後の本番環境移行
- パフォーマンス最適化

## 期待される効果

1. **ユーザビリティ向上**
   - 直感的な期間指定（2025/01/01-2025/07/15）
   - 現在のUI維持による学習コスト削減

2. **データ取得精度向上**
   - 必要な期間のデータのみ取得
   - 無駄なデータ取得の削減

3. **システム安定性向上**
   - RSS API制約を考慮した設計
   - エラーハンドリングの充実

4. **拡張性確保**
   - 新しい時間軸への対応容易
   - 複数銘柄一括処理の効率化