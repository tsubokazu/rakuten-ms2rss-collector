# VBAコンパイルエラー修正ガイド

## エラー「プロシージャの外では無効です」の対処法

このエラーは通常、以下の問題が原因で発生します：

### よくある原因

1. **不正な文字エンコーディング**
2. **フォーム定義の構文エラー**
3. **モジュールレベルでの不正なコード**
4. **参照設定の問題**

## 修正版ファイルの使用

**コンパイルエラーが発生する場合は、修正版ファイルを使用してください：**

```
❌ vba/src-sjis/        - 完全版（エラーの可能性）
✅ vba/src-sjis-fixed/  - 修正版（エラー回避）⭐
```

### 修正版の特徴

- **最小限の機能**に絞った安全な実装
- **複雑なUI要素を削除**
- **エラーハンドリングを簡素化**
- **参照依存を最小化**

## インポート手順（修正版）

### 1. VBAエディタを開く
- `Alt + F11` でVBAエディタを開く

### 2. 既存モジュールの削除
エラーが発生している場合は、既存のモジュールをすべて削除：
1. プロジェクトエクスプローラーで各モジュールを右クリック
2. 「削除」を選択
3. 「いいえ」を選択（エクスポートしない）

### 3. 修正版モジュールのインポート

**`vba/src-sjis-fixed/modules/` から以下をインポート：**

```
1. Utils.bas            ← 最初にインポート
2. DataCollector.bas    
3. MainModule.bas       ← ShowMainForm含む
4. WorksheetMacros.bas  ← ボタン用マクロ
```

### 4. 修正版フォームのインポート

**`vba/src-sjis-fixed/forms/MainForm.frm` をインポート**

### 5. 参照設定（最小限）

「ツール」→「参照設定」で以下のみ有効化：
- ✅ Microsoft Office Object Library
- ✅ Microsoft Forms 2.0 Object Library

## 修正版の機能

### 利用可能な機能
- `ShowMainForm()` - 簡易GUIフォーム表示
- `QuickTest()` - 基本テスト実行
- `StartDataCollection()` - ボタン用マクロ
- `TestConnection()` - 接続テスト

### 簡素化された点
- 複雑なUI要素を削除
- エラーハンドリングを簡略化
- ログ機能を最小限に縮小
- クラスモジュールを除外

## 使用例

### 基本テスト
```vba
Sub Test()
    Call ShowMainForm
End Sub
```

### 直接データ取得テスト
```vba
Sub DirectTest()
    Dim result As Boolean
    result = CollectStockData("7203", "5M", Date-1, Date)
End Sub
```

## トラブルシューティング

### それでもエラーが発生する場合

1. **Excelを完全に再起動**
2. **新しいブックを作成**
3. **一つずつモジュールをインポート**して問題箇所を特定

### 段階的インポート手順

```
Step 1: Utils.bas のみインポート → コンパイル確認
Step 2: DataCollector.bas 追加 → コンパイル確認  
Step 3: MainModule.bas 追加 → コンパイル確認
Step 4: WorksheetMacros.bas 追加 → コンパイル確認
Step 5: MainForm.frm 追加 → コンパイル確認
```

### コンパイル確認方法

VBAエディタで：
1. 「デバッグ」→「VBAProjectのコンパイル」
2. エラーが表示されないことを確認

## エラー別対処法

### 「プロシージャの外では無効です」
- **原因**: モジュールレベルでの構文エラー
- **対処**: 修正版ファイルを使用

### 「ユーザー定義型は定義されていません」  
- **原因**: 参照設定不足
- **対処**: 必要な参照ライブラリを追加

### 「オブジェクトが見つかりません」
- **原因**: フォーム定義エラー
- **対処**: 修正版MainForm.frmを使用

## 最小構成での動作確認

修正版で正常動作確認後、必要に応じて機能を追加：

```vba
' 1. 基本動作確認
Sub BasicTest()
    Call ShowMainForm
End Sub

' 2. 機能追加前のテスト
Sub ExtendedTest()
    Call QuickTest
End Sub
```

## まとめ

**重要**: コンパイルエラーが発生する場合は、必ず `vba/src-sjis-fixed/` フォルダの修正版ファイルを使用してください。

- 📂 `src-sjis-fixed/` → エラー回避版（推奨）⭐
- 📂 `src-sjis/` → 完全版（エラーの可能性）

修正版で基本動作を確認してから、必要に応じて機能を拡張してください。